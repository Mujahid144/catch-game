<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Catch the Emojis</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }
    canvas { background: #f0f0f0; display: block; margin: 0 auto; }
    #scoreBoard {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      font-weight: bold;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="scoreBoard">Score: 0</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let basket = { x: 160, y: 550, width: 80, height: 20 };
let objects = [];
let objectSpeed = 2;
let spawnInterval = 2000;
let score = 0;
let token = new URLSearchParams(window.location.search).get("token");

if (!token) {
  alert("❌ Invalid or expired link.");
  throw new Error("No token provided.");
}

function drawBasket() {
  ctx.fillStyle = "#007bff";
  ctx.fillRect(basket.x, basket.y, basket.width, basket.height);
}

function drawObjects() {
  ctx.fillStyle = "green";
  objects.forEach(obj => {
    ctx.beginPath();
    ctx.arc(obj.x, obj.y, obj.radius, 0, Math.PI * 2);
    ctx.fill();
  });
}

function spawnObject() {
  const radius = 15;
  const x = Math.random() * (canvas.width - radius * 2) + radius;
  objects.push({ x: x, y: 0, radius: radius });
}

function updateObjects() {
  for (let i = objects.length - 1; i >= 0; i--) {
    objects[i].y += objectSpeed;
    if (objects[i].y > canvas.height) {
      objects.splice(i, 1); // missed
      continue;
    }
    if (
      objects[i].y + objects[i].radius > basket.y &&
      objects[i].x > basket.x &&
      objects[i].x < basket.x + basket.width
    ) {
      score++;
      document.getElementById("scoreBoard").innerText = `Score: ${score}`;
      objects.splice(i, 1);
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBasket();
  drawObjects();
  updateObjects();
  requestAnimationFrame(draw);
}

document.addEventListener("keydown", e => {
  if (e.key === "ArrowLeft" && basket.x > 0) basket.x -= 20;
  if (e.key === "ArrowRight" && basket.x + basket.width < canvas.width) basket.x += 20;
});

setInterval(spawnObject, spawnInterval);

let speedTimer = 0;
const speedBoost = setInterval(() => {
  objectSpeed *= 2;
  spawnInterval /= 2;
  clearInterval(spawnObjectInterval);
  spawnObjectInterval = setInterval(spawnObject, spawnInterval);
  speedTimer += 30;
  if (speedTimer >= 180) clearInterval(speedBoost); // Stop boost after 3 minutes if needed
}, 30000);

let spawnObjectInterval = setInterval(spawnObject, spawnInterval);

window.addEventListener("beforeunload", async () => {
  if (score > 0 && token) {
    try {
      await fetch("http://localhost:5000/submit_score", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: token, score: score })
      });
    } catch (err) {
      console.error("Score submit failed:", err);
    }
  }
});

draw();
</script>
</body>
</html>
